#!/bin/bash
set -e

{{ if .is_macos -}}
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

{{ else if .is_linux -}}
echo "Linux detected"

if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew (Linuxbrew)..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # Try common Linuxbrew paths
    if [ -f /home/linuxbrew/.linuxbrew/bin/brew ]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [ -f ~/.linuxbrew/bin/brew ]; then
        eval "$(~/.linuxbrew/bin/brew shellenv)"
    fi
fi

{{ end -}}

echo "Installing Homebrew packages..."
brew bundle --file={{ .chezmoi.sourceDir }}/Brewfile

if command -v rustup &> /dev/null && ! rustup show &> /dev/null; then
    echo "Initializing Rust..."
    rustup-init -y
    source "$HOME/.cargo/env"
fi

echo "Setting up Python 3.12..."
uv python install 3.12

if command -v fish &> /dev/null; then
    echo "Setting up Fish plugins..."
    # Ensure fish_plugins file exists
    mkdir -p "$HOME/.config/fish"
    if [ ! -f "$HOME/.config/fish/fish_plugins" ] && [ -f "{{ .chezmoi.sourceDir }}/dot_config/fish/fish_plugins" ]; then
        cp "{{ .chezmoi.sourceDir }}/dot_config/fish/fish_plugins" "$HOME/.config/fish/fish_plugins"
    fi
    # Install fisher and plugins in a single fish session
    if [ -f "$HOME/.config/fish/fish_plugins" ]; then
        fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source; and fisher"
    fi
fi

echo "âœ… Bootstrap complete!"
